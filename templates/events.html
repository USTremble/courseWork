{% extends 'base.html' %}
{% block title %}События{% endblock %}
{% block content %}
<h1>События</h1>

{% for cat,msg in get_flashed_messages(with_categories=True) %}
  <p style="color:{% if cat=='error' %}#ff7070{% else %}var(--accent){% endif %};">{{ msg }}</p>
{% endfor %}

{% if not team %}
  <p>Вы не состоите в команде.</p>
{% else %}
  {% if events %}
      {% for e in events %}
      <div class="content-box"
     data-event="{{ e[0] }}"
     style="margin-bottom:16px; position:relative">
  <span class="close"
        style="position:absolute;right:12px;top:10px;cursor:pointer;font-size:1.2rem"
        onclick="dismissEvent({{ e[0] }}, this)">✖</span>
            <h2>{{ e[1] }} <small>({{ e[2] }})</small></h2>

            {% if e[2] == 'waiting' %}
                Ожидание других команд…
            {% elif e[2] == 'running' %}
                {% if e[6] %}
                    <p><a href="{{ url_for('static', filename=e[6]) }}" target="_blank">
                        Скачать задание (PDF)</a></p>
                {% endif %}
                <form method="post" action="{{ url_for('submit_answer', eid=e[0]) }}">
                    <input name="answer" placeholder="Ответ" required>
                    <button class="btn">Отправить</button>
                </form>
            {% else %}
                <p>Событие завершено.</p>
            {% endif %}

            <p style="margin-top:8px">
                Ваши очки:   <strong>{{ e[5] }}</strong><br>
                Победители: <strong>{{ e[7] }}</strong>
            </p>
            </div>
        {% endfor %}
    {% endif %}

  {% if not events or all_finished %}
    <form method="post" class="content-box" style="max-width:380px">
      <label>Код события</label>
      <input name="code" required style="width:100%;padding:8px;margin:8px 0">
      <button class="btn">Присоединиться</button>
    </form>
  {% endif %}
{% endif %}

<!-- авто-перезагрузка + запоминание закрытых карточек -->
<script>
    function dismissedList(){
      return JSON.parse(localStorage.getItem('dismissedEvents') || '[]');
    }
    function saveList(lst){
      localStorage.setItem('dismissedEvents', JSON.stringify(lst));
    }
    
    /* скрываем сохранённые */
    document.querySelectorAll('[data-event]').forEach(div=>{
       const id = +div.dataset.event;
       if (dismissedList().includes(id)) div.remove();
    });
    
    /* закрыть карточку + запомнить */
    function dismissEvent(id, el){
       const box = el.closest('[data-event]');
       box && box.remove();
       const lst = dismissedList();
       if (!lst.includes(id)){ lst.push(id); saveList(lst); }
    }
    </script>
{% endblock %}
