{% extends 'base.html' %}
{% block title %}Пользователи{% endblock %}

{% block content %}
<h1>Пользователи</h1>

<form style="margin-bottom:12px">
  <input type="text" name="q" placeholder="Поиск по UID / TID / логину"
         value="{{ q }}" style="padding:6px 8px;width:280px">
  <button class="btn">Поиск</button>
</form>

<div style="display:flex;justify-content:space-between;align-items:center">
  <h2>Список&nbsp;пользователей</h2>
  <button class="btn btn-outline" onclick="location.reload()">Обновить&nbsp;таблицу</button>
</div>

<div class="content-box">
<table class="admin-table">
  <thead>
    {% set dir_icon = '↑' if order == 'asc' else '↓' %}
    {% macro hdr(field,label) -%}
      <a href="{{ url_for('admin_users', q=q, sort=field,
               dir='desc' if sort==field and order=='asc' else 'asc') }}">
         {{ label }}{% if sort==field %} {{ dir_icon }}{% endif %}
      </a>
    {%- endmacro %}
    <tr>
      <th>{{ hdr('user_id','UID') }}</th>
      <th>{{ hdr('username','Логин') }}</th>
      <th>Команда&nbsp;(TID)</th>
      <th>{{ hdr('role','Роль') }}</th>
      <th>{{ hdr('is_blocked','Статус') }}</th>
      <th>Действие</th>
    </tr>
  </thead>
  <tbody>
  {% for u in users %}
    <tr>
      <td>{{ u[0] }}</td>
      <td>{{ u[1] }}</td>
      <td>{{ u[2] }}</td>
      <td>{{ u[3] }}</td>
      <td>
        {% if u[4] %}
          <span class="status blocked">Заблокирован</span>
        {% else %}
          <span class="status active">Активен</span>
        {% endif %}
      </td>
      <td>
        <div class="action-wrapper">
          <span class="action-btn">Выполнить&nbsp;действие</span>
          <div class="action-menu">
            <form method="post" action="{{ url_for('admin_user_action') }}">
              <input type="hidden" name="uid" value="{{ u[0] }}">
              <button name="act" value="moder">Назначить&nbsp;модератором</button>
              <button name="act" value="toggle">
                {{ 'Разблокировать' if u[4] else 'Заблокировать' }}
              </button>
              <button name="act" value="delete"
                      onclick="return confirm('Удалить аккаунт UID {{u[0]}}?')">
                Удалить аккаунт
              </button>
            </form>
          </div>
        </div>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
</div>

<!-- пагинация -->
<div class="table-pagination">
  {% for p in range(1,pages+1) %}
    {% if p == page %}<strong>{{ p }}</strong>
    {% else %}
      <a href="{{ url_for('admin_users', page=p, q=q, sort=sort, dir=order) }}">{{ p }}</a>
    {% endif %}
  {% endfor %}
</div>
{% endblock %}

<style>
.content-box{border:1px solid #c7d9e1;border-radius:8px;padding:18px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
.admin-table{border-collapse:collapse;width:100%}
.admin-table th,.admin-table td{padding:6px 8px;border:1px solid #d4dee4;text-align:center}
.admin-table thead{background:#f0f6fa;font-weight:600}
.status{display:inline-block;padding:2px 6px;border-radius:4px;color:#fff;font-size:12px}
.status.active  {background:#29c97d}
.status.blocked {background:#e05555}
.action-wrapper{position:relative;display:inline-block}
.action-btn{cursor:pointer;text-decoration:underline;color:#0084c6;font-size:14px}
.action-menu{display:none;position:absolute;right:0;top:20px;background:#fff;border:1px solid #c7d9e1;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.15);min-width:180px;z-index:20}
.action-menu button{display:block;width:100%;border:none;background:none;text-align:left;padding:8px 12px;font-size:14px;cursor:pointer}
.action-menu button:hover{background:#f0f6fa}
.action-wrapper:hover .action-menu{display:block}
</style>
