{% extends 'base.html' %}
{% block title %}Проведение события{% endblock %}
{% block content %}
<h1>Панель модератора</h1>

<form method="post" class="content-box" style="max-width:320px">
  <label>Код события</label>
  <input name="code" value="{{ code_entered }}">
  <button class="btn" style="margin-top:8px">Открыть</button>
</form>

{% if ev %}
<div class="content-box" id="eventPanel" style="margin-top:20px;position:relative">
  <span class="close"
        style="position:absolute;right:12px;top:10px;cursor:pointer;font-size:1.3rem"
        onclick="document.getElementById('eventPanel').remove()">✖</span>

  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2>Управление событием — {{ ev[1] }} ({{ ev[2] }})</h2>
    <button class="btn btn-outline" onclick="location.reload()">Обновить таблицу</button>
  </div>

  {% if ev[2]=='waiting' %}
     <form method="post" style="margin-bottom:12px">
       <input type="hidden" name="code" value="{{ code_entered }}">
       <button name="start" class="btn">Начать событие</button>
     </form>
  {% elif ev[2]=='running' %}
     <form method="post" style="margin-bottom:12px">
       <input type="hidden" name="code" value="{{ code_entered }}">
       <button name="finish" class="btn btn-outline">Завершить событие</button>
     </form>
  {% endif %}

  <table class="admin-table">
    <thead><tr>
      <th>Команда</th><th>Очки</th><th>Последний ответ</th><th>Время</th><th></th>
    </tr></thead>
    <tbody>
    {% for t in teams %}
      <tr>
        <td>{{ t[1] }}</td>
        <td>{{ t[2] }}</td>
        <td>{{ t[3] }}</td>
        <td>{{ t[4] or '' }}</td>
        <td>
            {% if ev[2] != 'finished' %}
              <div class="action-wrapper">
                <a class="action-btn" href="#">⋯</a>
                <div class="action-menu">
                  <form method="post" class="action-form" data-sign="1">
                    <input type="hidden" name="code"  value="{{ code_entered }}">
                    <input type="hidden" name="tid"   value="{{ t[0] }}">
                    <input type="hidden" name="delta">
                    <button name="pts">Добавить очки</button>
                  </form>
                  <form method="post" class="action-form" data-sign="-1">
                    <input type="hidden" name="code"  value="{{ code_entered }}">
                    <input type="hidden" name="tid"   value="{{ t[0] }}">
                    <input type="hidden" name="delta">
                    <button name="pts">Снять очки</button>
                  </form>
                  <form method="post">
                    <input type="hidden" name="code"  value="{{ code_entered }}">
                    <input type="hidden" name="tid"   value="{{ t[0] }}">
                    <button name="dq" style="color:#e05555">Дисквалифицировать</button>
                  </form>
                </div>
              </div>
            {% endif %}
          </td>          
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<script>
    /* выпадающее меню */
    document.querySelectorAll('.action-wrapper').forEach(w=>{
      const menu = w.querySelector('.action-menu');
      w.querySelector('.action-btn').onclick=e=>{
        e.preventDefault(); menu.classList.toggle('open');
      };
    });
    
    /* модальное ввода Δ очков */
    document.querySelectorAll('.action-form').forEach(f=>{
      f.onsubmit = ()=>{
        const sign = parseInt(f.dataset.sign);
        let n = prompt('Сколько очков (1–10)?');
        if(!n) return false;
        n = parseInt(n);
        if(isNaN(n)||n<1||n>10){ alert('Введите число 1–10'); return false; }
        f.delta.value = sign * n;
        return true;
      };
    });
</script>
    
<style>
    .action-wrapper{position:relative;display:inline-block}
    .action-btn{padding:4px 8px;border:1px solid var(--accent);border-radius:4px;font-size:.9rem}
    .action-menu{display:none;position:absolute;z-index:5;right:0;top:110%;background:#fff;
                 box-shadow:0 4px 8px rgba(0,0,0,.1);padding:8px;border-radius:6px}
    .action-menu.open,.action-wrapper:hover .action-menu{display:block}
    .action-menu button{background:none;border:none;text-align:left;padding:4px 6px;width:100%}
    .action-menu button:hover{background:#f0f0f0;cursor:pointer}
</style>
    
{% endblock %}
