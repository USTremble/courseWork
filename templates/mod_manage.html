{% extends 'base.html' %}
{% block title %}Проведение события{% endblock %}

{% block content %}
<h1>Проведение события</h1>

{# ─── панель модератора (waiting + running) ─── #}
{% if not ev %}
  <form method="get" class="content-box" style="max-width:340px">
    <label>Код события</label>
    <input name="code" value="{{ code_entered }}" required>
    <button class="btn" style="margin-top:6px">Открыть</button>
  </form>

  {% if wait_cards %}
    <h2 style="margin-top:28px">Ожидающие / Идут</h2>
    <div class="card-grid">
      {% for w in wait_cards %}
        <div class="card">
          <h4>{{ w[2] }}</h4>
          <p>{{ w[4] }}</p>
          <p>Тип: {{ w[3]|upper }}</p>
          <p>Статус: {{ w[6] }}</p>
          <p>Команд: {{ w[5] }}</p>
          <form method="get">
            <input type="hidden" name="code" value="{{ w[1] }}">
            <button class="btn">Провести событие</button>
          </form>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endif %}

{# ─── управление выбранным событием ─── #}
{% if ev %}
  <div class="content-box" style="margin-top:24px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">{{ ev[1] }} <small>({{ ev[2] }})</small></h2>
      <a href="{{ url_for('mod_manage', close=1) }}"
         style="font-size:22px;text-decoration:none">&#10005;</a>
    </div>

    <div style="margin:16px 0">
      {% if ev[2]=='waiting' %}
        <form method="post" style="display:inline">
          <input type="hidden" name="code" value="{{ code_entered }}">
          <button name="start" class="btn">Начать событие</button>
        </form>
      {% elif ev[2]!='finished' %}
        <form method="post" style="display:inline">
          <input type="hidden" name="code" value="{{ code_entered }}">
          <button name="finish" class="btn">Завершить событие</button>
        </form>
      {% endif %}
    </div>

    <table class="admin-table">
      <thead>
        <tr>
          <th>#</th><th>Команда</th><th>Очки</th>
          <th>Последний ответ / время</th>
          {% if ev[2] != 'finished' %}<th>Действие</th>{% endif %}
        </tr>
      </thead>
      <tbody>
      {% for t in teams %}
        <tr>
          <td>{{ loop.index }}</td>
          <td style="text-align:left">{{ t[1] }}</td>
          <td>{{ t[2] }}</td>
          <td style="text-align:left">{{ t[3] }}&nbsp;<small>{{ t[4] }}</small></td>

          {% if ev[2] != 'finished' %}
          <td>
            <select onchange="doAct(this, '{{ t[0] }}')">
              <option selected disabled>⋮</option>
              <option value="+1">+ очко</option>
              <option value="-1">− очко</option>
              <option value="dq">Дисквалифицировать</option>
            </select>
          </td>
          {% endif %}
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <form id="actFrm" method="post" style="display:none">
    <input type="hidden" name="tid">
    <input type="hidden" name="delta">
    <input type="hidden" name="code" value="{{ code_entered }}">
  </form>
{% endif %}
{% endblock %}

{# ─── стили и JS ─── #}
<style>
.content-box{border:1px solid #c7d9e1;border-radius:8px;padding:18px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:16px;margin-top:16px}
.card{border:1px solid #c7d9e1;border-radius:8px;padding:14px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
.btn{background:#0084c6;color:#fff;padding:6px 12px;border:none;border-radius:4px;cursor:pointer}
.admin-table{border-collapse:collapse;width:100%;margin-top:8px}
.admin-table th,.admin-table td{padding:6px 8px;border:1px solid #d4dee4;text-align:center}
.admin-table thead{background:#f0f6fa;font-weight:600}
</style>

<script>
function doAct(sel, tid){
  const v = sel.value;
  sel.selectedIndex = 0;                      // сброс селекта
  if(!v) return;

  if(v==='dq' && !confirm('Дисквалифицировать команду?')) return;

  const frm = document.getElementById('actFrm');
  frm.tid.value = tid;
  frm.delta.value = (v==='dq' ? -255 : v);
  frm.submit();
}
</script>
