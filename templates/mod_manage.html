{% extends 'base.html' %}
{% block title %}Проведение события{% endblock %}

{% block content %}
<h1>Проведение события</h1>

{% if not ev %}
  <form method="get" class="content-box" style="max-width:340px">
    <label>Код события</label>
    <input name="code" value="{{ code_entered }}" required>
    <button class="btn" style="margin-top:6px">Открыть</button>
  </form>

  {% if active_events %}
    <h2 style="margin-top:28px">Ожидающие / Идущие</h2>
    <div class="card-grid">
      {% for w in active_events %}
        <div class="card">
          <h4>{{ w[1] }}</h4>
          <p>{{ w[2] }}</p>
          <p>Тип: {{ w[3]|upper }}</p>
          <p>Статус: {{ w[4] }}</p>
          <p>Команд: {{ w[5] }}</p>
          <form method="get">
            <input type="hidden" name="code" value="{{ w[0] }}">
            <button class="btn">Провести событие</button>
          </form>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endif %}

{% if ev %}
  <div class="content-box" style="margin-top:24px">

    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">
        {{ ev[1] }} <small>({{ ev[2] }})</small>
      </h2>
      <a href="{{ url_for('mod_manage', close=1) }}"
         style="font-size:22px;text-decoration:none;">&#10005;</a>
    </div>

    <div style="margin:16px 0; display:flex; gap:8px; align-items:center;">
      {% if ev[2]=='waiting' %}
        <form method="post" style="display:inline">
          <input type="hidden" name="code" value="{{ code_entered }}">
          <button name="start" class="btn">Начать событие</button>
        </form>
      {% elif ev[2]!='finished' %}
        <form method="post" style="display:inline">
          <input type="hidden" name="code" value="{{ code_entered }}">
          <button name="finish" class="btn">Завершить событие</button>
        </form>
      {% endif %}
      <button class="btn btn-outline" onclick="location.reload()">Обновить таблицу</button>
    </div>

    <table class="admin-table">
      <thead>
        <tr>
          <th>#</th><th>Команда</th><th>Очки</th>
          <th>Последний ответ / время</th>
          {% if ev[2] != 'finished' %}<th>Действие</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for t in teams %}
        <tr>
          <td>{{ loop.index }}</td>
          <td style="text-align:left">{{ t[1] }}</td>
          <td>{{ t[2] }}</td>
          <td style="text-align:left">
            {{ t[3] }}<span style="margin-left:6px">{{ t[4] }}</span>
          </td>
          {% if ev[2] != 'finished' %}
          <td>
            <div class="action-wrapper">
              <a href="#" class="action-btn">Выполнить действие</a>
              <div class="action-menu">
                <button type="button" onclick="showDeltaPrompt('add', {{ t[0] }})">
                  Добавить очки
                </button>
                <button type="button" onclick="showDeltaPrompt('sub', {{ t[0] }})">
                  Убрать очки
                </button>
                <button type="button" class="btn-danger" onclick="doDisq({{ t[0] }})">
                  Дисквалифицировать
                </button>
              </div>
            </div>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <form id="actFrm" method="post" style="display:none">
      <input type="hidden" name="tid">
      <input type="hidden" name="delta">
      <input type="hidden" name="dq">
      <input type="hidden" name="code" value="{{ code_entered }}">
    </form>

    <script>
      function showDeltaPrompt(type, tid) {
        const msg = type==='add'
          ? 'Сколько очков добавить?'
          : 'Сколько очков убрать?';
        const val = prompt(msg);
        if (val === null) return;
        const n = parseInt(val, 10);
        if (isNaN(n) || n <= 0) {
          alert('Введите положительное число');
          return;
        }
        const frm = document.getElementById('actFrm');
        frm.tid.value = tid;
        frm.delta.value = type==='sub' ? -n : n;
        frm.submit();
      }
      function doDisq(tid) {
        if (!confirm('Дисквалифицировать команду?')) return;
        const frm = document.getElementById('actFrm');
        frm.tid.value = tid;
        frm.dq.value = 1;
        frm.submit();
      }
    </script>

  </div>
{% endif %}
{% endblock %}

<style>
.content-box{border:1px solid #c7d9e1;border-radius:8px;padding:18px;
             box-shadow:0 2px 6px rgba(0,0,0,.06)}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
           gap:16px;margin-top:16px}
.card{border:1px solid #c7d9e1;border-radius:8px;padding:14px;
      box-shadow:0 2px 6px rgba(0,0,0,.06)}
.btn{background:#0084c6;color:#fff;padding:6px 12px;border:none;
     border-radius:4px;cursor:pointer}
.btn-outline{background:#fff;color:#0084c6;border:1px solid #0084c6}
.btn-danger{color:#e05555;border:none;background:none;cursor:pointer}
.admin-table{border-collapse:collapse;width:100%;margin-top:8px}
.admin-table th,.admin-table td{padding:6px 8px;border:1px solid #d4dee4;
      text-align:center}
.admin-table thead{background:#f0f6fa;font-weight:600}
.action-wrapper{position:relative;display:inline-block}
.action-btn{cursor:pointer;text-decoration:underline;color:#0084c6}
.action-menu{display:none;position:absolute;right:0;top:20px;background:#fff;
             border:1px solid #c7d9e1;border-radius:6px;
             box-shadow:0 2px 6px rgba(0,0,0,.15);z-index:20}
.action-menu button{display:block;width:100%;padding:8px 12px;
             background:none;border:none;text-align:left;cursor:pointer}
.action-wrapper:hover .action-menu{display:block}
</style>
