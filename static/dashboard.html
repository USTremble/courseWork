<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Главная</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  
  <nav class="sidebar"><div class="logo">CyberBattle</div><div id="navLinks"></div></nav>
  <header class="topbar"><div class="top-title">Главная</div>
    <div class="avatar-menu"><span id="uname"></span>
      <img src="/static/default-avatar.png" class="avatar" id="aBtn">
      <div class="dropdown" id="dd"><a href="/profile.html">Профиль</a><a href="#" id="lo">Выйти</a></div>
    </div>
  </header>
  
  <main>
    <h1 style="text-align:center;margin:20px 0">CyberBattle</h1>
    <section class="content-box" style="max-width:900px;margin:auto">
      <p>
        Добро пожаловать на CyberBattle — платформу для командных соревнований в формате викторин и CTF! 
      </p>
      <p>
        Ниже представлены 15 последних завершённых событий, их победители и таблицы лидеров. 
      </p>
      <p>Погрузитесь в атмосферу соревнований и готовьтесь к новым вызовам!</p>
      
    </section>
  
    <h2 id="noev" style="margin-top:36px;display:none">Завершённых событий пока нет.</h2>
    <div class="card-grid" id="evGrid"></div>
  </main>
  
  <script type="module">
    import { initCommon } from '/static/js/common.js';
    await initCommon('Главная');
    
    const html = s => { const t = document.createElement('template'); t.innerHTML = s.trim(); return t.content.firstChild; };
  
    const res = await fetch('/api/dashboard',{credentials:'include'});
    const data = (await res.json()).data;
    if(!data.length) document.getElementById('noev').style.display = 'block';
  
    const grid = document.getElementById('evGrid');
    data.forEach(ev => {
      const card = html(`
        <div class="card">
          <h4>${ev.name}</h4>
          <p>Тип: ${ev.type.toUpperCase()}</p>
          <p>${ev.description}</p>
          <p>Победитель: <strong>${ev.winner}</strong></p>
          <button class="btn">Подробнее</button>
        </div>
      `);
      const dlg = html(`
        <div class="modal">
          <div class="modal-body">
            <h3 style="margin-top:0">${ev.name}</h3>
            <p>${ev.description}</p>
            <p><strong>Тип:</strong> ${ev.type.toUpperCase()}</p>
            <h4 style="margin:24px 0 12px">Лидерборд</h4>
            <table class="admin-table">
              <thead>
                <tr><th>#</th><th>Команда</th><th>Очки</th></tr>
              </thead>
              <tbody id="lb"></tbody>
            </table>
            <button class="btn close-btn">Закрыть</button>
          </div>
        </div>
      `);
      // заполняем лидерборд
      ev.leaderboard.forEach(r => {
        dlg.querySelector('tbody').appendChild(
          html(`<tr${r[1]===ev.winner?' style="background:#FFD300"':''}>
                  <td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td>
               </tr>`)
        );
      });
      card.querySelector('.btn').onclick = () => dlg.style.display = 'flex';
      dlg.querySelector('.close-btn').onclick = () => dlg.style.display = 'none';
      dlg.onclick = e => { if (e.target === dlg) dlg.style.display = 'none'; };
      document.body.appendChild(dlg);
      grid.appendChild(card);
    });
  </script>
  
  <style>
    .content-box {
      border:1px solid #c7d9e1;
      border-radius:8px;
      padding:18px;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
    .card-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:16px;
      margin-top:16px;
    }
    .card {
      border:1px solid #c7d9e1;
      border-radius:8px;
      padding:14px;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
    .card h4 { margin:0 0 6px; }
    .btn {
      background:#0084c6;
      color:#fff;
      padding:6px 12px;
      border:none;
      border-radius:4px;
      cursor:pointer;
      margin-top:6px;
    }

    /* МОДАЛКА */
    .modal {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      z-index:999;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .modal-body {
      background:#1f293e;
      color:#fff;
      border:1px solid #4a5a75;
      border-radius:8px;
      padding:24px;
      max-width:600px;
      width:100%;
      box-shadow:0 4px 12px rgba(0,0,0,.25);
    }
    .modal-body h3,
    .modal-body p,
    .modal-body table {
      margin-bottom:12px;
    }
    .modal-body table {
      width:100%;
      border-collapse:collapse;
    }
    /* Заголовки остаются белыми */
    .modal-body th {
      padding:8px;
      border:1px solid #375176;
      text-align:center;
      color:#fff;
    }
    /* Текст ячеек теперь чёрный */
    .modal-body td {
      padding:8px;
      border:1px solid #375176;
      text-align:center;
      color:#ffffff;
    }
    .modal-body thead {
      background:#22304d;
      font-weight:600;
    }
    .close-btn {
      display:block;
      margin:20px auto 0;
      background:#2563eb;
      color:#fff;
      padding:8px 16px;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }
  </style>
</body>
</html>
