<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>События</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<nav class="sidebar">
  <div class="logo">IB Competition</div>
  <div id="navLinks"></div>
</nav>

<header class="topbar">
  <div class="top-title">События</div>
  <div class="avatar-menu">
    <span id="uname"></span>
    <img src="/static/default-avatar.png" class="avatar" id="aBtn">
    <div class="dropdown" id="dd">
      <a href="/profile.html">Профиль</a>
      <a href="#" id="lo">Выйти</a>
    </div>
  </div>
</header>

<main style="padding-bottom:60px">
  <h1>События</h1>
  <div id="content"></div>
</main>

<script type="module">
import { initCommon } from '/static/js/common.js';
await initCommon('События');

const html=s=>{const t=document.createElement('template');t.innerHTML=s.trim();return t.content.firstChild;};
const $=q=>document.querySelector(q);
let poll=null;

async function render(){
  const r=await fetch('/api/events',{credentials:'include'});
  const d=(await r.json()).data;
  const root=$('#content'); root.innerHTML='';
  if(!d.team){root.textContent='Нужно состоять в команде.';return;}

  if(d.current_event){
    const ev=d.current_event; const lb=d.leaderboard;
    const box=html(`<div class="content-box">
       <h2>${ev[1]}</h2><p>${ev[4]}</p>
       <p><strong>Статус:</strong> ${ev[2]=='waiting'?'Ожидание':'В процессе'}</p>
       <div id="extra"></div></div>`);
    const extra=box.querySelector('#extra');

    if(ev[2]=='waiting'){extra.innerHTML='<p>Ожидание других команд…</p>';}
    if(ev[2]=='running'){
      if(ev[5]){
        extra.appendChild(html(`<p style="margin-top:8px">
          <a href="/static/${ev[5]}" class="btn" download>Скачать задание (PDF)</a></p>`));
        extra.appendChild(html(`<form id="ans" style="margin-top:14px">
            <input name="answer" placeholder="Ответ" style="padding:6px 8px;width:240px" required>
            <button class="btn">Отправить</button></form>`));
      }
      extra.appendChild(html(`<h3 style="margin:22px 0 8px">Лидерборд</h3>
        <table class="admin-table small"><thead><tr><th>#</th><th>Команда</th><th>Очки</th></tr></thead>
        <tbody id="lb"></tbody></table>`));
      lb.forEach((r,i)=>extra.querySelector('#lb')
        .appendChild(html(`<tr${i==0?' style="background:#e1f7ee"':''}>
          <td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>`)));
      $('#ans')?.addEventListener('submit',async e=>{
        e.preventDefault();
        const fd=new FormData(e.target);
        await fetch('/api/events/submit/'+ev[0],{
          method:'POST',credentials:'include',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({answer:fd.get('answer')})});
        e.target.reset(); render();
      });
      poll??=setInterval(render,10000);
    }
    root.appendChild(box); return;
  }

  clearInterval(poll); poll=null;

  root.appendChild(html(`<div class="content-box" style="max-width:420px">
    <h3>Присоединиться по коду</h3>
    <form id="codeF"><input name="code" maxlength="16" placeholder="Код события"
      style="padding:6px 8px;width:220px" required>
      <button class="btn">Присоединиться</button></form></div>`));
  $('#codeF').addEventListener('submit',async e=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const rr=await fetch('/api/events/join',{method:'POST',credentials:'include',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({code:fd.get('code')})});
    if(rr.ok) render(); else alert((await rr.json()).msg||'Ошибка');
  });

  if(d.waiting.length){
    root.appendChild(html('<h3 style="margin-top:28px">Доступные события</h3>'));
    const grid=html('<div class="card-grid"></div>');root.appendChild(grid);
    d.waiting.forEach(ev=>{
      const card=html(`<div class="card"><h4>${ev[1]}</h4>
        <p>Тип: ${ev[2].toUpperCase()}</p><p>${ev[3]}</p>
        <p>Команд в очереди: ${ev[4]}</p><button class="btn">Участвовать</button></div>`);
      card.querySelector('.btn').onclick=async ()=>{
        await fetch('/api/events/join',{method:'POST',credentials:'include',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({event_id:ev[0]})});
        render();
      };
      grid.appendChild(card);
    });
  }else root.appendChild(html('<p style="margin-top:20px">Нет активных событий.</p>'));
}
render();
</script>

<style>
.content-box{border:1px solid #c7d9e1;border-radius:8px;padding:18px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;margin-top:12px}
.card{border:1px solid #c7d9e1;border-radius:8px;padding:14px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
.card h4{margin:0 0 6px}
.btn{background:#0084c6;color:#fff;padding:6px 12px;border:none;border-radius:4px;cursor:pointer}
.admin-table{border-collapse:collapse;width:100%}
.admin-table.small td,.admin-table.small th{padding:4px 6px}
.admin-table th,.admin-table td{padding:6px 8px;border:1px solid #d4dee4;text-align:center}
.admin-table thead{background:#f0f6fa;font-weight:600}
</style>
</body></html>
